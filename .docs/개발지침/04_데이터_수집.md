# 해외 주식 데이터 수집 및 처리 지침 (해외주식_데이터수집_지침.md)

본 문서는 프로젝트에서 사용하는 해외 주식 데이터(미국 주식, ETF 등)의 수집 방법, 주기, 저장 규칙을 정의합니다. 모든 개발 및 데이터 로직 구현 시 본 지침을 **최우선**으로 따릅니다.

## 1. 데이터 소스 (Source of Truth)
*   **실시간 및 단기 데이터 (Real-time & 5m Bars)**
    *   **Primary Source**: **한국투자증권 (KIS) API**
    *   **대상 종목**: **SOXL, SOXS, UPRO** (핵심 레버리지/인버스 ETF) 및 주요 감시 종목
    *   **수집 항목**:
        *   실시간 현재가 (Live Price)
        *   5분봉 데이터 (5-minute Candles)
## 2. 데이터 수집 전략 (DB 중심 하이브리드)
데이터 효율성과 안정성을 위해 **DB 저장 및 증분 업데이트(Incremental Update)** 방식을 적용합니다.

### 2.1 데이터 소스 우선순위 및 역할 분담 (Hybrid Source)
| 구분 | 1순위 소스 | 2순위 소스 (백업/보완) | 역할 및 특징 |
|------|-----------|-----------------------|--------------|
| **과거 데이터 (Historical)** | **yfinance** | 한국투자증권 (KIS) | **Bulk Fetch**: 대량 조회 시 yfinance가 빠르고 유리함. 실패 시 KIS로 보완. |
| **최신/실시간 (Real-time)** | **한국투자증권 (KIS)** | yfinance | **Live Stream**: 정확한 실시간 시세 및 1초 단위 변동 감지용. |
| **환율 (USD/KRW)** | **yfinance** | 한국투자증권 | **Asset Value**: 안정적인 환율 정보 제공. |

### 2.2 DB 활용 메커니즘 (Incremental Fetch)
1. **로드**: DB에서 해당 종목의 **마지막 저장된 캔들 시간(Last Candle Time)**을 조회합니다.
2. **증분 요청**: 마지막 시간 **이후**의 데이터만 외부(yfinance/KIS)에 요청합니다. (불필요한 중복 호출 제거)
3. **병합(Merge)**: [DB에 있던 과거 데이터] + [새로 가져온 최신 데이터]를 메모리상에서 합쳐 분석에 사용합니다.
4. **저장(Persist)**: 새로 가져온 최신 데이터는 즉시 DB에 저장(Upsert)하여 다음 번에 재사용합니다.

### 2.3 데이터 저장 스키마 (`market_candles`)
**테이블 구조**:
- `ticker`: 종목 코드 (PK, 예: SOXL)
- `timeframe`: 봉 주기 (PK, 예: 30m, 5m)
- `candle_time`: 캔들 시작 시간 (PK, DateTime)
- `open`, `high`, `low`, `close`: 가격 정보 (Float)
- `volume`: 거래량 (BigInt)
- `source`: 데이터 출처 (yfinance, kis)

### 2.4 수집 대상 및 주기
| 종목 | 데이터 종류 | 갱신 주기 | 용도 |
|------|------------|-----------|------|
| **SOXL, SOXS** | 30분봉, 5분봉 | 5분 마다 | 메인 트레이딩 신호 산출 |
| **UPRO** | 30분봉, 1일봉 | 30분 마다 | 시장 추세(Bull/Bear) 판단 |
| **환율** | 실시간 | 1시간 마다 | 원화 자산 가치 평가 |

## 3. 거래 시간 및 데이터 범위 (Market Hours)
*   **모든 시간대 포함 (Extended Hours)**: 프리마켓/애프터마켓 데이터 필수 포함.
*   **타임존**: DB 저장은 UTC 기준, 화면 표시는 KST 기준.
