# MASTER CONTROL TOWER 신호 테스트 가이드

**작성일**: 2026-01-11  
**목적**: `market_indices` 테이블을 이용한 신호 발생 테스트

---

## 개요

MASTER CONTROL TOWER는 `market_indices` 테이블의 `current_price`를 사용하여 신호 조건을 비교합니다. 이 테이블의 가격을 임의로 변경하면 실시간으로 신호 발생을 테스트할 수 있습니다.

---

## 신호 비교 로직

### 매도 신호 (V2SignalStatus.jsx)

```javascript
// Step 1: 이익실현 - 상향 돌파
if (step.key === 'sell_sig1_yn') {
    conditionMet = currentPrice >= targetPrice;
}

// Step 2/3: 손절/청산 - 하향 돌파
else if (step.key === 'sell_sig2_yn' || step.key === 'sell_sig3_yn') {
    conditionMet = currentPrice <= targetPrice;
}
```

### 데이터 흐름

```
market_indices (DB)
  ↓ (10초마다 폴링)
/api/v2/status
  ↓
Frontend (current_price 사용)
  ↓
신호 조건 비교
```

---

## 테스트 방법

### 방법 1: API 사용 (권장)

**테스트용 API 엔드포인트**: `POST /api/test/market-price`

#### 요청 예시

```bash
# SOXL 가격을 $60으로 설정 (등락률 +10%)
curl -X POST http://localhost:9100/api/test/market-price \
  -H "Content-Type: application/json" \
  -d '{
    "ticker": "SOXL",
    "price": 60.00,
    "change_pct": 10.00
  }'

# SOXS 가격을 $2.50으로 설정 (등락률 -5%)
curl -X POST http://localhost:9100/api/test/market-price \
  -H "Content-Type: application/json" \
  -d '{
    "ticker": "SOXS",
    "price": 2.50,
    "change_pct": -5.00
  }'
```

#### 원래 값으로 되돌리기

```bash
# SOXL 원복
curl -X POST http://localhost:9100/api/test/market-price \
  -H "Content-Type: application/json" \
  -d '{
    "ticker": "SOXL",
    "price": 53.95,
    "change_pct": 8.66
  }'

# SOXS 원복
curl -X POST http://localhost:9100/api/test/market-price \
  -H "Content-Type: application/json" \
  -d '{
    "ticker": "SOXS",
    "price": 2.36,
    "change_pct": -8.17
  }'
```

### 방법 2: SQL 직접 사용

#### 가격 업데이트

```sql
-- SOXL 가격 변경
UPDATE market_indices 
SET current_price = 60.00, change_pct = 10.00 
WHERE ticker = 'SOXL';

-- SOXS 가격 변경
UPDATE market_indices 
SET current_price = 2.50, change_pct = -5.00 
WHERE ticker = 'SOXS';
```

#### 실행 방법

```bash
mysql -h 114.108.180.228 -P 3306 -u blueeye -pblueeye0037! mywork_01 \
  -e "UPDATE market_indices SET current_price = 60.00, change_pct = 10.00 WHERE ticker = 'SOXL';"
```

---

## 테스트 시나리오

### 시나리오 1: 매도 신호 (Step 1: 이익실현) 테스트

1. **목표가 설정**: SOXL Step 1 목표가를 $55로 설정
2. **가격 변경**: SOXL을 $60으로 변경
3. **결과 확인**:
   - 조건: $60 >= $55 → ✅ 충족
   - 신호 발생: Step 1 빨간색 원 + ✓
   - 음성 알림: `SOXLS1.mp3` 재생

### 시나리오 2: 손절 신호 (Step 2) 테스트

1. **목표가 설정**: SOXL Step 2 손절가를 $50으로 설정
2. **가격 변경**: SOXL을 $48로 변경
3. **결과 확인**:
   - 조건: $48 <= $50 → ✅ 충족
   - 신호 발생: Step 2 빨간색 원 + ✓
   - 음성 알림: `SOXLS2.mp3` 재생

### 시나리오 3: 신호 해제 테스트

1. **현재 상태**: Step 1 신호 활성화 (목표가 $55, 현재가 $60)
2. **가격 변경**: SOXL을 $54로 변경
3. **결과 확인**:
   - 조건: $54 >= $55 → ❌ 미충족
   - 신호 해제: Step 1 회색 원 (대기 상태)

---

## 현재 값 확인

### SQL 조회

```sql
SELECT ticker, current_price, change_pct, updated_at 
FROM market_indices 
WHERE ticker IN ('SOXL', 'SOXS', 'UPRO');
```

### API 조회

```bash
curl http://localhost:9100/api/v2/status | jq '.SOXL.buy.current_price, .SOXL.buy.change_pct'
```

---

## 주의사항

### 1. 자동 업데이트

- `market_indices` 테이블은 실시간 API에 의해 주기적으로 업데이트됩니다.
- 테스트 중 실시간 업데이트로 값이 덮어씌워질 수 있습니다.
- 테스트 후 빠르게 확인하거나, 실시간 업데이트 스케줄러를 일시 중지하세요.

### 2. 폴링 주기

- Frontend는 10초마다 `/api/v2/status`를 호출합니다.
- 가격 변경 후 최대 10초 내 UI에 반영됩니다.

### 3. 음성 알림

- 신호가 OFF → ON 될 때만 음성이 재생됩니다.
- 이미 ON 상태면 음성이 재생되지 않습니다.
- 테스트 시 신호를 한 번 OFF 한 후 다시 ON 하세요.

---

## 트러블슈팅

### 신호가 반응하지 않음

1. Backend 재시작 확인
2. `/api/v2/status` 응답 확인
3. 브라우저 콘솔에서 네트워크 요청 확인

### 가격이 업데이트되지 않음

1. SQL 실행 결과 확인 (affected rows)
2. `updated_at` 컬럼 확인
3. 캐시 문제: 브라우저 새로고침 (`Ctrl+Shift+R`)

---

## 관련 파일

| 파일 | 역할 |
|------|------|
| `db.py` | `get_live_status()` |
| `main.py` | `/api/test/market-price` |
| `V2SignalStatus.jsx` | 신호 비교 로직 |

---

**작성자**: Antigravity  
**버전**: 1.0
