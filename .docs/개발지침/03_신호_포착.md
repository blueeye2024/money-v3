# 신호포착 시스템 구현지침 (Ver 3.5)

**문서 버전**: 3.5.0  
**최종 업데이트**: 2026-01-08  
**담당 시스템**: 실시간 신호 포착 & 알림 내역

---

## 📋 목차

1. [시스템 개요](#시스템-개요)
2. [신호 발생 히스토리](#신호-발생-히스토리)
3. [문자 발송 시스템](#문자-발송-시스템)
4. [데이터베이스 구조](#데이터베이스-구조)
5. [UI 컴포넌트](#ui-컴포넌트)
6. [API 엔드포인트](#api-엔드포인트)

---

## 시스템 개요

### 핵심 기능
신호포착 시스템은 **MASTER CONTROL TOWER**에서 발생한 매수/매도 신호를 기록하고, SMS 알림을 발송합니다.
Ver 3.5부터 **누적 신호 달성(Cumulative Signal Completion)** 로직이 적용되어, 1/2/3차 신호가 순차적으로 달성되더라도 최종 매수가 확정됩니다.

### 주요 구성요소
1. **신호 발생 히스토리**: 자동 탐지된 매수/매도 신호 기록
2. **문자 발송 히스토리**: SMS 발송 내역 및 상태
3. **SMS 전체 가동**: 문자 발송 ON/OFF 제어

### 데이터 흐름
```
MASTER CONTROL TOWER (신호 분석)
    ↓
1차(5분)/2차(박스)/3차(30분) 개별 달성 시 DB 기록 (Latched)
    ↓
3가지 신호 모두 달성 확인 (순서 무관, 누적 체크)
    ↓
'최종 매수 완료(Final)' DB 기록 & SMS 발송
    ↓
매도 감시 모드(Holding)로 전환
```

---

## 신호 발생 히스토리

### 저장 조건 (Logic Ver 3.5)

#### 1. 최종 진입 (Final Buy) 확정 로직
기존의 "동시 만족" 조건에서 "누적 달성(Latched Logic)" 조건으로 개선되었습니다.

```python
# backend/analysis.py

# 1, 2, 3차 신호가 DB에 모두 'Y'로 기록되어 있는지 확인
all_met = (state.get("buy_sig1_yn") == 'Y' and 
           state.get("buy_sig2_yn") == 'Y' and 
           state.get("buy_sig3_yn") == 'Y')

if all_met and state.get("final_buy_yn") == 'N':
    # 최종 진입 확정
    save_v2_buy_signal(manage_id, 'final', current_price)
    # SMS 발송 "최종매수(V2)"
```

#### 2. 중복 방지
```python
# 30분 이내 동일 종목 BUY 신호 확인
cursor.execute("""
    SELECT id FROM signal_history 
    WHERE ticker=%s AND signal_type='BUY (MASTER)' 
    AND created_at >= NOW() - INTERVAL 30 MINUTE 
    LIMIT 1
""", (ticker,))

if not cursor.fetchone():  # ← 없으면 저장
    save_signal({...})
```

#### 3. State 초기화
시스템이 매도 모드(SELL)로 전환되면 BUY 관련 State는 리셋되지 않고 유지되다가, 매도가 완료되면(Final Sell) 다음 사이클을 위해 초기화됩니다.

### 표시 형식

#### 테이블 컬럼
| 컬럼 | 너비 | 정렬 | 설명 |
|------|------|------|------|
| 발생 시간 | 160px | left | yyyy.MM.dd HH:mm (초 제거) |
| 종목 | 90px | left | SOXL, SOXS, UPRO |
| 구분 | 90px | center | 매수/매도/경보 (한글) |
| 신호 이유 | auto | left | signal_reason 또는 interpretation |
| 신호가 | 110px | right | $XX.XX (소수점 2자리) |
| 현재가 | 110px | right | $XX.XX (MASTER CONTROL TOWER에서 가져옴) |
| 수익률 | 100px | center | +X.XX% (계산) |
| 관리 | 80px | center | 삭제 버튼 |

#### 구분 표시
```javascript
// BUY/SELL 판단
const isBuy = signalType.includes('BUY');
const isSell = signalType.includes('SELL');
const isWarning = signalType.includes('WARNING');

if (isBuy) {
    actionText = '매수';
    // Red color
} else if (isSell) {
    actionText = '매도';
    // Blue color
}
```

---

## 문자 발송 시스템

### 문자 발송 조건
1. **SMS 전체 가동 ON**
2. **신호 발생**: 진입(1차/2차/3차/최종), 경보, 청산
3. **중복 방지**: 30분 이내 동일 유형 발송 제한

---

## 데이터베이스 구조

### signal_history 테이블
```sql
CREATE TABLE signal_history (
    id INT AUTO_INCREMENT PRIMARY KEY,
    ticker VARCHAR(10) NOT NULL,
    name VARCHAR(100),
    signal_type VARCHAR(50),           -- 'BUY (MASTER)', 'SELL', 'WARNING'
    signal_reason VARCHAR(100),        -- Ver 3.0: 신호 발생 이유
    position_desc VARCHAR(255),
    price DECIMAL(10, 2),
    signal_time DATETIME,
    time_kst VARCHAR(50),
    time_ny VARCHAR(50),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    is_sent BOOLEAN DEFAULT FALSE,
    score INT,
    interpretation VARCHAR(255)
);
```

### buy_stock / sell_stock 테이블 (V2)
실시간 상태 추적을 위한 테이블입니다.
- `buy_sig1_yn` ~ `buy_sig3_yn`: 각 단계 달성 여부 (Y/N)
- `final_buy_yn`: 최종 매수 완료 여부 (Y/N)
- `real_buy_yn`: 사용자 실매수 확정 여부 (Y/N)

---
