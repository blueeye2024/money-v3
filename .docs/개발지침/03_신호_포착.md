# 신호포착 시스템 구현지침 (Ver 3.5)

**문서 버전**: 3.5.1  
**최종 업데이트**: 2026-01-08  
**담당 시스템**: 실시간 신호 포착 & 알림 내역

---

## 📋 목차

1. [시스템 개요](#시스템-개요)
2. [신호 발생 히스토리](#신호-발생-히스토리)
3. [문자 발송 시스템](#문자-발송-시스템)
4. [데이터베이스 구조](#데이터베이스-구조)
#### 2. 상태 표시 (Signal Status)
- **신호 활성 시**: 기존 설명 텍스트 대신 **신호 발생 가격**을 표시합니다.
    - 예: `75.43` (단순 신호)
    - 예: `Target: 78.50` (목표가 설정된 경우)
- **신호 대기 시**: 신호 설명(예: "5분봉 GC")이 표시됩니다.
- **색상**: 매수(Red)/매도(Blue) 모드에 따라 테두리 및 텍스트 색상이 변경됩니다.
- **목표가 초기화**: 수동으로 신호를 취소(OFF)하면, 설정된 목표가도 즉시 삭제(초기화)됩니다.
6. [API 엔드포인트](#api-엔드포인트)

---

## 시스템 개요

### 핵심 기능
신호포착 시스템은 **MASTER CONTROL TOWER**에서 발생한 매수/매도 신호를 기록하고, SMS 알림을 발송합니다.
Ver 3.5부터 **누적 신호 달성(Cumulative Signal Completion)** 및 **뒷북 감지(Catch-up)** 로직이 적용되어, 신호의 누락 없이 정확한 매매 타이밍을 포착합니다.

### 주요 구성요소
1. **신호 발생 히스토리**: 자동 탐지된 매수/매도 신호 기록
2. **문자 발송 히스토리**: SMS 발송 내역 및 상태
3. **SMS 전체 가동**: 문자 발송 ON/OFF 제어

### 데이터 흐름
```
MASTER CONTROL TOWER (신호 분석)
    ↓
1차(5분)/2차(박스)/3차(30분) 개별 달성 시 DB 기록 (Latched)
    ↓
3가지 신호 모두 달성 확인 (순서 무관, 누적 체크)
    ↓
'최종 매수 완료(Final)' DB 기록 & SMS 발송 (매도 모드 전환)
    ↓
3차 청산(30분 DC) 발생 시 '최종 청산 완료' 기록 (매수 모드 복귀)
```

---

## 신호 발생 히스토리

### 저장 조건 (Logic Ver 3.5)

#### 1. 최종 진입 (Final Buy) 확정 로직
기존의 "동시 만족" 조건에서 "누적 달성(Latched Logic)" + "**실시간 검증(Auto-Reset)**" 조건으로 개선되었습니다.
*   **누적 달성**: 각 단계별 신호가 발생하면 DB에 'Y'로 기록됩니다.
*   **자동 해제(Auto-Reset)**: 1차(5분 GC) 등 추세 기반 신호는 조건이 해제되면(데드크로스) 즉시 'N'으로 리셋됩니다.
*   **Catch-up**: 30분봉/5분봉의 골든크로스 시점을 놓쳐도 **이미 정배열(Trend Up) 상태**라면 신호를 발생시킵니다.

```python
# backend/analysis.py

# 1. Auto-Reset Check
if state.get("buy_sig1_yn") == 'Y' and condition_lost:
    state["buy_sig1_yn"] = 'N' # DB Update -> 'N'

# 2. Final Check
all_met = (state.get("buy_sig1_yn") == 'Y' and 
           state.get("buy_sig2_yn") == 'Y' and 
           state.get("buy_sig3_yn") == 'Y')
```

#### 2. 청산 신호 (Sell Signal) 확정 로직
매도 신호 역시 데드크로스 발생 시점뿐만 아니라, **이미 역배열(Trend Down) 상태**인 경우에도 신호를 발생시킵니다.

- **1차(5분 DC)**: 5분봉 데드크로스 OR 5분봉 역배열 (조건 해제 시 자동 리셋)
- **2차(손절/익절)**: 진입가 대비 하락 OR 사용자 설정 **하향 이탈가** 도달
- **3차(30분 DC)**: 30분봉 데드크로스 OR 30분봉 역배열 (조건 해제 시 자동 리셋)
- **최종 청산(Final Sell)**: 3차 청산(30분 DC)이 발생하면 즉시 최종 청산으로 확정됩니다.

```python
# 30m DC (Sig 3) 발생 시
if save_v2_sell_signal(manage_id, 'sig3', curr_price):
    # 자동으로 Final Sell 처리
    save_v2_sell_signal(manage_id, 'final', curr_price)
```

#### 3. 중복 방지
```python
# 30분 이내 동일 종목 BUY 신호 확인
cursor.execute("""
    SELECT id FROM signal_history 
    WHERE ticker=%s AND signal_type='BUY (MASTER)' 
    AND created_at >= NOW() - INTERVAL 30 MINUTE 
    LIMIT 1
""", (ticker,))

if not cursor.fetchone():  # ← 없으면 저장
    save_signal({...})
```

### 표시 형식

#### 테이블 컬럼
| 컬럼 | 너비 | 정렬 | 설명 |
|------|------|------|------|
| 발생 시간 | 160px | left | yyyy.MM.dd HH:mm (초 제거) |
| 종목 | 90px | left | SOXL, SOXS, UPRO |
| 구분 | 90px | center | 매수/매도/경보 (한글) |
| 신호 이유 | auto | left | signal_reason 또는 interpretation |
| 신호가 | 110px | right | $XX.XX (소수점 2자리) |
| 현재가 | 110px | right | $XX.XX (MASTER CONTROL TOWER에서 가져옴) |
| 수익률 | 100px | center | +X.XX% (계산) |
| 관리 | 80px | center | 삭제 버튼 |

#### 구분 표시
```javascript
// BUY/SELL 판단
const isBuy = signalType.includes('BUY');
const isSell = signalType.includes('SELL');
const isWarning = signalType.includes('WARNING');

if (isBuy) {
    actionText = '매수';
    // Red color
} else if (isSell) {
    actionText = '매도';
    // Blue color
}
```

---

## 문자 발송 시스템

### 문자 발송 조건
1. **SMS 전체 가동 ON**
2. **신호 발생**: 진입(1차/2차/3차/최종), 경보, 청산
3. **중복 방지**: 30분 이내 동일 유형 발송 제한

---

## 데이터베이스 구조

### signal_history 테이블
```sql
CREATE TABLE signal_history (
    id INT AUTO_INCREMENT PRIMARY KEY,
    ticker VARCHAR(10) NOT NULL,
    name VARCHAR(100),
    signal_type VARCHAR(50),           -- 'BUY (MASTER)', 'SELL', 'WARNING'
    signal_reason VARCHAR(100),        -- Ver 3.0: 신호 발생 이유
    position_desc VARCHAR(255),
    price DECIMAL(10, 2),
    signal_time DATETIME,
    time_kst VARCHAR(50),
    time_ny VARCHAR(50),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    is_sent BOOLEAN DEFAULT FALSE,
    score INT,
    interpretation VARCHAR(255)
);
```

### buy_stock / sell_stock 테이블 (V2)
실시간 상태 추적을 위한 테이블입니다.
- `buy_sig1_yn` ~ `buy_sig3_yn`: 각 단계 달성 여부 (Y/N)
- `final_buy_yn`: 최종 매수 완료 여부 (Y/N)
- `real_buy_yn`: 사용자 실매수 확정 여부 (Y/N)

---

## Ver 3.0 엔진 (Ver 3.0 Data Engine)

### **Ver 3.0 엔진 개요**
Ver 3.0 엔진은 **"데이터 무결성(Data Integrity)"**과 **"실시간성(Real-time)"**을 동시에 만족시키기 위해 설계된 차세대 데이터 처리 엔진입니다. 단순 API 호출에 의존하지 않고, 자체 데이터베이스에 핵심 종목의 데이터를 **'최적화된 상태(Optimized State)'**로 유지합니다.

### **핵심 기능 및 사양**
#### 1. 30분봉/5분봉 전용 데이터 테이블 (Rolling Window)
*   일반적인 전체 데이터 수집과 달리, 주요 종목(SOXS, SOXL, UPRO)에 대해 별도의 최적화된 테이블을 운영합니다.
*   **3일 롤링 윈도우(Rolling Window)**: 항상 **"매매 가능한 최근 3거래일(Trading Days)"** 데이터만 유지합니다. 휴일, 주말에도 로직에 의해 직전 거래일 3일치가 보존됩니다.
*   **데이터 정합성**: 5분마다 전체 데이터 검증 및 갱신을 수행하여 중복이나 누락을 원천 차단합니다.

#### 2. 하이브리드 데이터 소스 (Hybrid Data Source)
*   **Yahoo Finance (Base)**: 기본적으로 방대한 과거 데이터 및 안정적인 시계열 데이터를 제공합니다.
*   **KIS API Fallback (Real-time)**: Yahoo 데이터가 실시간 시장보다 10분 이상 지연될 경우, 자동으로 **한국투자증권(KIS) 실시간 시세 API**를 호출하여 최신 5분봉 데이터를 긴급 수혈(Patching)합니다.
*   이를 통해 **"과거 데이터의 안정성" + "현재 가격의 즉시성"**을 모두 확보했습니다.

#### 3. 시장 지표 영구 보관 (Persistent Indicator Log)
*   휘발성으로 계산되고 사라지던 보조지표들을 별도 테이블(`market_indicators_log`)에 영구 기록합니다.
*   **저장 항목**:
    *   **기본 지표**: RSI(14), Volume Ratio, ATR, Pivot R1
    *   **신호 발생 시각**: 30분봉/5분봉의 골든크로스(GC), 데드크로스(DC) 발생 정확한 시각(KST)
*   이 데이터는 향후 **백테스팅(Backtesting)** 및 **대시보드 차트 시각화**의 핵심 자원으로 활용됩니다.

#### 4. 안전한 API 스케줄링
*   API 호출 제한(Rate Limit)을 고려하여 종목 간 **5초 지연(Delay)** 및 **분산 처리** 로직이 적용되었습니다.
*   365일 24시간 무중단 운영이 가능하도록 예외 처리 및 자동 복구 기능이 내장되어 있습니다.
