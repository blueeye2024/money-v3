# MASTER CONTROL TOWER 개발 지침

## 1. 개요

MASTER CONTROL TOWER는 SOXL(BULL TOWER)과 SOXS(BEAR TOWER)의 **3단계 매매 신호 시스템**입니다. Ver 3.6.1 이후 **VIX 공포 지수 경보** 및 **하이브리드 데이터 수집** 시스템이 탑재되었습니다.

### 핵심 티커
| 티커 | 타입 | 설명 | 데이타 소스 |
|------|------|------|------------|
| **SOXL** | BULL TOWER | Direxion Daily Semiconductor Bull 3X | **KIS API (실시간)** |
| **SOXS** | BEAR TOWER | Direxion Daily Semiconductor Bear 3X | **KIS API (실시간)** |
| **UPRO** | 추가 모니터링 | ProShares UltraPro S&P500 (3X) | **KIS API (실시간)** |
| **^SOX** | 지수 | 필라델피아 반도체 지수 | YFinance |
| **^VIX** | 지수 | CBOE Volatility Index | YFinance |

---

## 2. 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────┐
│                     FRONTEND (React)                    │
├─────────────────────────────────────────────────────────┤
│  V2SignalStatus.jsx - BULL/BEAR TOWER 시그널 UI         │
│  MarketInsight.jsx  - 시장 상황판 & VIX 경보            │
│  - 실시간 폴링 (5초 주기)                                │
│  - VIX 레벨별 경고 배너 표출                             │
└─────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│                     BACKEND (FastAPI)                   │
├─────────────────────────────────────────────────────────┤
│  main.py                                                │
│  ├─ monitor_signals() (1분) : 시그널 감시 & SMS 알림    │
│  └─ /api/v2/status/{ticker} : 시그널 & 가격 상태 제공   │
│                                                         │
│  analysis.py                                            │
│  ├─ refresh_market_indices() : 하이브리드 데이터 수집   │
│  └─ populate_candles : 3일치 5분봉 캔들 유지            │
└─────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│                     DATABASE (MySQL)                    │
├─────────────────────────────────────────────────────────┤
│  buy_stock / sell_stock : 3단계 신호 상태 저장          │
│  market_indices  : 실시간 가격 (Single Source)          │
│  soxl_candle_data : 5분봉 캔들 (최근 3거래일)           │
└─────────────────────────────────────────────────────────┘
```

---

## 3. 매매 신호 시스템

### 3.1 매수 신호 (BUY) - 3단계

| 단계 | 키 | 조건 | 설명 |
|------|-----|------|------|
| **1차** | `buy_sig1_yn` | 5분봉 골든 크로스 (GC) | 추세 시작 |
| **2차** | `buy_sig2_yn` | 박스권 상단 + 2% 돌파 | 강력 돌파 |
| **3차** | `buy_sig3_yn` | 30분봉 골든 크로스 (GC) | 추세 확정 |
| **최종** | `final_buy_yn` | 3차 모두 충족 | 진입 완료 |

### 3.2 매도 신호 (SELL) - 3단계

| 단계 | 키 | 조건 | 설명 |
|------|-----|------|------|
| **1차** | `sell_sig1_yn` | 5분봉 데드 크로스 (DC) | 단기 조정 |
| **2차** | `sell_sig2_yn` | 손절가/익절가 도달 | 리스크 관리 |
| **3차** | `sell_sig3_yn` | 30분봉 데드 크로스 (DC) | 추세 이탈 |
| **최종** | `final_sell_yn` | 청산 확정 | 포지션 종료 |

---

## 4. VIX 공포 지수 경보 시스템 (New)

시장의 변동성(VIX)을 실시간 분석하여 대시보드 상단에 경고를 표시합니다. SMS 알림 없이 **상황판 시각 알림**으로만 제공됩니다.

| 레벨 | VIX 범위 | 아이콘 | 색상 | 행동 지침 |
|------|----------|--------|------|-----------|
| **EXTREME** | **≥ 30** | 🚨 | **Red** | **극도의 공포**. 신규 진입 금지, 현금 비중 확대 |
| **HIGH** | ≥ 25 | ⚠️ | Orange | 높은 변동성. 보수적 접근 권고 |
| **ELEVATED** | ≥ 20 | 📊 | Yellow | 변동성 상승. 주의 필요 |
| **NORMAL** | ≥ 15 | ✅ | Green | 정상 시장 |
| **LOW** | < 15 | 😌 | Blue | 과열 가능성 (평온) |

---

## 5. 데이터 수집 및 흐름 (Hybrid Architecture)

### 5.1 데이터 수집 소스
데이터의 성격에 따라 두 가지 소스를 혼합하여 **속도**와 **데이터 커버리지**를 최적화했습니다.

| 구분 | 대상 티커 | 소스 | 특징 | 업데이트 주기 |
|------|----------|------|------|--------------|
| **핵심 종목** | SOXL, SOXS, UPRO | **KIS API** | **실시간** (지연 없음) | 5분 (또는 실시간 호출) |
| **시장 지수** | S&P500, NASDAQ, VIX, SOX | **YFinance** | 15분 지연 | 5분 (Fallback) |
| **환율/원자재** | KRW=X, GC=F | **YFinance** | 지연 | 5분 |

### 5.2 데이터 흐름 (Data Flow)

1. **Backend Collection**:
   - `monitor_signals`가 돌면서 `refresh_market_indices()` 호출
   - KIS API로 주요 종목 가격 갱신 → `market_indices` 테이블 저장
   - YFinance로 나머지 지수 갱신 → `market_indices` 테이블 저장

2. **Frontend Polling**:
   - **5초 주기**로 `/api/v2/status` 호출
   - API는 `market_indices` 테이블(DB)을 조회하여 즉시 응답 (외부 API 호출 안 함)
   - **부하 방지**: 사용자 트래픽이 늘어도 DB 조회만 발생하므로 안전함

---

## 6. 캔들 데이터 관리

기술적 분석(골든/데드크로스)을 위한 분봉 데이터 관리 정책입니다.

- **테이블**: `soxl_candle_data`, `soxs_candle_data`, `upro_candle_data`
- **수집 간격**: **5분** (4분 30초 아님)
- **보관 기간**: 휴일 제외 **최근 3거래일**
- **로직**: `populate_candles.py`에서 매번 `TRUNCATE` 후 최신 3일치를 YFinance+KIS로 다시 채움 (무결성 보장)

---

## 7. API 엔드포인트

### 7.1 시그널 상태 조회
```
GET /api/v2/status/{ticker}
```
- DB의 `market_indices`를 참조하여 즉각 응답
- VIX, SOX 등 지수 데이터도 `metrics` 또는 `market_info`에 포함 가능

### 7.2 수동 조작 및 확정
- `POST /api/v2/manual-signal`: 1차/2차/3차 조건 강제 달성 처리
- `POST /api/v2/confirm-buy`: 실매수 기록 생성 (보유 상태 전환)
- `POST /api/v2/confirm-sell`: 청산 기록 생성 (손익 확정)

---

## 8. 버전 히스토리

| 버전 | 날짜 | 변경 내용 |
|------|------|----------|
| **3.9.5** | 2026-01 | **VIX 경보 시스템** 추가, SOX 지수 데이터 연동 |
| **3.9.5** | 2026-01 | **하이브리드 데이터 수집** (KIS 실시간 + YF 지수) 적용 |
| **3.9.5** | 2026-01 | 프론트엔드 폴링 주기 최적화 (10s → **5s**) |
| 3.9 | 2026-01 | 오디오 알림 추가 |
| 3.6.1 | 2026-01 | market_indices Single Source 적용 |
| 3.0 | - | V2 시그널 시스템 도입 |
