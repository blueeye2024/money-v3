# MASTER CONTROL TOWER: 통합 개발 지침 (Consolidated Guidelines)

> **Version**: Ver 5.0
> **Last Updated**: 2026-01-13
> **Status**: Active

---

## 1. 개요 (Overview)
본 문서는 `MASTER CONTROL TOWER` 시스템의 모든 개발 규칙, 신호 로직, 데이터 처리에 대한 **단일 진실 공급원(SSOT)**입니다.
모든 개발 및 유지보수는 본 지침을 최우선으로 준수해야 합니다.

---

## 2. 핵심 원칙 (Core Principles)
1.  **데이터 무결성**: 모든 가격 및 등락률 데이터는 `market_indices` 테이블을 기준으로 합니다.
2.  **신호 명확성**: 사용자에게 보여지는 신호 단계는 내부 로직과 1:1로 매핑되어야 합니다.
3.  **1종목 1포지션**: `buy_stock` 테이블에는 종목당 최대 1개의 레코드만 존재합니다.

---

## 3. 매매 신호 로직 (Signal Logic - SOXL/SOXS) - Ver 5.0

### 3-1. 공통 로직
*   **데이터 소스**: DB (`soxl_candle_data`, `soxs_candle_data`) + KIS API (Real-time Price)
*   **상태 갱신**: 매 분(Minute) 단위 루프 실행 (`analysis.py`).

### 3-2. 진입 신호 3단계 (3-Step Entry) - Ver 5.0
| 단계 | 명칭 | 조건 | 비고 |
| :-- | :-- | :-- | :-- |
| **Step 1** | **5분봉 골든크로스 (Timing)** | 5분봉 MA10 > MA30 | 단기 진입 시점 포착 (비휘발성) |
| **Step 2** | **박스권 돌파 (Momentum)** | 전일 대비 +2.0% 이상 상승 | 상승 모멘텀 확인 |
| **Step 3** | **30분봉 골든크로스 (Trend Confirm)** | 30분봉 MA10 > MA30 | 중기 추세 확정 (가장 중요) |

> **Note**: 1, 2, 3단계가 모두 충족(`True`)되면 **[최종 진입 신호 (Final)]**가 발생합니다.

### 3-3. 청산 신호 (Exit)
1.  **5분봉 데드크로스**: 단기 이익 실현 또는 경고(Warning).
2.  **진입가 이탈**: 손절매(Stop Loss) - 원금 보전 최우선.
3.  **30분봉 데드크로스**: 추세 이탈 - 전량 매도 권장.

---

## 4. 버전 히스토리 (Version History)
*   **Ver 3.6.1 (2026-01-11)**: 대시보드 UI 개선, 데이터 로딩 최적화.
*   **Ver 5.0 (2026-01-13)**: SOXL/SOXS 신호 로직 전면 개편 (3단계 필터링 적용), 데이터 파이프라인 안정화.

---

## 5. 배포 절차


```bash
# 1. Frontend 빌드
cd frontend && npm run build

# 2. Nginx 재시작
echo 'blueeye0037!' | sudo -S systemctl restart nginx

# 3. Backend 재시작 (필요시)
echo 'blueeye0037!' | sudo -S systemctl restart cheongan-backend
```

### 5-2. 배포 후 백업 정책 (Mandatory Backup) - Ver 5.3 추가
Git 커밋 및 배포가 완료되면, 반드시 **백업 폴더**에 현재 소스 코드를 복제하여 보관합니다.
(가상환경 `venv`, `node_modules` 등 크기가 큰 라이브러리 폴더는 제외합니다.)

**[백업 실행 절차]**
1. **폴더명 규칙**: `backup/money_Ver[버전]_[YYYYMMDD_HHMM]`
2. **제외 항목**: `backup/`, `node_modules/`, `venv/`, `.git/`, `__pycache__/`, `dist/`
3. **명령어 예시**:
   ```bash
   mkdir -p backup/money_v5.3_20260114_0341
   rsync -av --exclude 'backup' --exclude 'node_modules' --exclude 'venv' --exclude '.git' --exclude '__pycache__' --exclude 'dist' . backup/money_v5.3_20260114_0341/
   ```


---

## 5. MASTER CONTROL TOWER 관련

자세한 내용은 [04_MASTER_CONTROL_TOWER.md](file:///home/blue/blue/my_project/money/필수지침/개발지침/04_MASTER_CONTROL_TOWER.md) 참조

## 6. [Ver 4.3.0] 주요 변경 사항 (2026-01-12)

### 1) 하이브리드 신호 시스템 (Hybrid Signal System)
- **수동 고정 (Locked)**: 사용자가 수동으로 신호를 켜면(`is_manual='Y'`), 자동 로직에 의해 꺼지지 않고 **계속 유지**됩니다.
- **자동 토글 (Auto Toggle)**: 수동 설정이 없는 경우, 조건 부합 여부에 따라 **실시간으로 신호가 ON/OFF** 됩니다 (Non-Sticky).
- **보유 상태 유지**: 실매수(`real_buy_qn > 0`) 상태에서는 진입 조건이 해제되어도 '매도 감시 중'(`final`) 상태가 유지됩니다.

### 2) Git 보안 및 관리 정책
- **보안 강화**: 다음 파일/폴더는 Git에 절대 올리지 않습니다 (Local Only).
  - `필수지침/`, `.docs/` (내부 문서)
  - `*.md` (모든 마크다운 문서)
  - `kis_token.json`, `*.env` (보안 키)
- **배포 브랜치**: `v4.3.0-release` 등 릴리스 브랜치를 통해 배포합니다.


## 6. 브라우저 제어 지침
