# ì²­ì•ˆ(Cheongan) í”„ë¡œì íŠ¸ ì§„í–‰ì‚¬í•­

> **ìµœì¢… ì—…ë°ì´íŠ¸**: 2026-01-02 03:10 (KST)  
> **í˜„ì¬ ë²„ì „**: Ver 2.4.3 (Build: 2026-01-02 02:33)  
> **ì‘ì—… ì„¸ì…˜**: Dashboard UI Debugging & Holiday Fallback System

---

## ğŸ“‹ ëª©ì°¨
1. [í”„ë¡œì íŠ¸ ê°œìš”](#í”„ë¡œì íŠ¸-ê°œìš”)
2. [ìµœê·¼ ì£¼ìš” ì‘ì—… (2026-01-02)](#ìµœê·¼-ì£¼ìš”-ì‘ì—…-2026-01-02)
3. [í•µì‹¬ ê¸°ëŠ¥ êµ¬í˜„ ìƒíƒœ](#í•µì‹¬-ê¸°ëŠ¥-êµ¬í˜„-ìƒíƒœ)
4. [ì•Œë ¤ì§„ ì´ìŠˆ ë° í•´ê²° ë°©ë²•](#ì•Œë ¤ì§„-ì´ìŠˆ-ë°-í•´ê²°-ë°©ë²•)
5. [ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜](#ì‹œìŠ¤í…œ-ì•„í‚¤í…ì²˜)
6. [ë°°í¬ ë° ìš´ì˜](#ë°°í¬-ë°-ìš´ì˜)
7. [ë‹¤ìŒ ë‹¨ê³„](#ë‹¤ìŒ-ë‹¨ê³„)

---

## í”„ë¡œì íŠ¸ ê°œìš”

### ëª©ì 
ì²­ì•ˆ(Cheongan) í•´ì™¸ì£¼ì‹ ìë™ ë§¤ë§¤ ë° ë¶„ì„ ì‹œìŠ¤í…œì€ ë°˜ë„ì²´ ë ˆë²„ë¦¬ì§€ ETF(SOXL/SOXS)ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ í•œ ì‹¤ì „ íŠ¸ë ˆì´ë”© ì•Œê³ ë¦¬ì¦˜ ëŒ€ì‹œë³´ë“œì…ë‹ˆë‹¤.

### ê¸°ìˆ  ìŠ¤íƒ
- **Frontend**: React + Vite, React Router
- **Backend**: Python FastAPI, Pandas, yfinance, pytz
- **Database**: MySQL (MariaDB) on 114.108.180.228
- **API**: í•œêµ­íˆ¬ìì¦ê¶Œ (KIS) API (ì‹¤ì‹œê°„ ê°€ê²©)
- **Server**: Ubuntu Linux (gunicorn + systemd service)
- **Deployment**: Nginx reverse proxy â†’ Backend:9100

### í•µì‹¬ ì „ëµ
**íŠ¸ë¦¬í”Œ í•„í„° (Triple Filter) ì‹œìŠ¤í…œ**:
1. **Filter 1 (ì¶”ì„¸)**: 30ë¶„ë´‰ SMA 10/30 ê³¨ë“ í¬ë¡œìŠ¤
2. **Filter 2 (ê°•ë„)**: ë°•ìŠ¤ê¶Œ(ìµœê·¼ 20ê°œ 30ë¶„ë´‰) ìƒë‹¨ 2% ëŒíŒŒ
3. **Filter 3 (íƒ€ì´ë°)**: 5ë¶„ë´‰ SMA 10/30 ê³¨ë“ í¬ë¡œìŠ¤

**ê²½ê³  ì‹œìŠ¤í…œ (Warning States)**:
- ğŸŸ¡ **Yellow**: 5ë¶„ë´‰ ë°ë“œí¬ë¡œìŠ¤ â†’ 50% ê¸´ê¸‰ ìµì ˆ ê¶Œì¥
- ğŸŸ  **Orange**: ë°•ìŠ¤ê¶Œ í•˜í–¥ ì´íƒˆ â†’ ê°•ë„ ì•½í™” ì£¼ì˜
- ğŸ”´ **Red**: 30ë¶„ë´‰ ë°ë“œí¬ë¡œìŠ¤ â†’ ì „ëŸ‰ ë§¤ë„ + ì´ˆê¸°í™”

---

## ìµœê·¼ ì£¼ìš” ì‘ì—… (2026-01-02)

### ì„¸ì…˜ ëª©í‘œ
- Footer ë²„ì „ ì •ë³´ ì—…ë°ì´íŠ¸ ë° ë°°í¬ í™•ì¸
- SOXS/SOXL "Master Control Tower" í‘œì‹œ ì˜¤ë¥˜ ìˆ˜ì •
- íœ´ì¥ì¼(Holiday) ëŒ€ì‘ ì‹œìŠ¤í…œ êµ¬ì¶•
- ë°ì´í„° ìºì‹± ë° Fallback ë¡œì§ ê°•í™”

### 1. ì¹˜ëª…ì  ë²„ê·¸ ìˆ˜ì • âš ï¸

#### ë¬¸ì œ: `us_et` ë³€ìˆ˜ ë¯¸ì •ì˜ ì˜¤ë¥˜
**íŒŒì¼**: `backend/analysis.py` â†’ `check_triple_filter` í•¨ìˆ˜  
**ì¦ìƒ**: SOXS/SOXL ë¶„ì„ì´ ëª¨ë‘ ì‹¤íŒ¨í•˜ë©° ì—ëŸ¬ ë°œìƒ
```
NameError: name 'us_et' is not defined
```

**ì›ì¸**: 
- `check_triple_filter` í•¨ìˆ˜ ë‚´ì—ì„œ `us_et` íƒ€ì„ì¡´ ë³€ìˆ˜ê°€ ì •ì˜ë˜ì§€ ì•ŠìŒ
- 1328ë²ˆ ë¼ì¸ì—ì„œ `now_utc.astimezone(us_et)` í˜¸ì¶œ ì‹œ ì‹¤íŒ¨

**í•´ê²°**:
```python
# Line 1307-1308
kst = pytz.timezone('Asia/Seoul')
us_et = pytz.timezone('America/New_York')  # ì¶”ê°€ë¨
```

**ì˜í–¥**: 
- ì´ ë²„ê·¸ë¡œ ì¸í•´ ëª¨ë“  Master Signal ë¡œì§ì´ ì‘ë™í•˜ì§€ ì•Šì•˜ìŒ
- ìˆ˜ì • í›„ SOXS/SOXL ìƒíƒœê°€ ì •ìƒì ìœ¼ë¡œ ëŒ€ì‹œë³´ë“œì— í‘œì‹œë¨

---

### 2. íœ´ì¥ì¼ ëŒ€ì‘ ì‹œìŠ¤í…œ êµ¬ì¶• ğŸ–ï¸

#### ë°°ê²½
- ë¯¸êµ­ ì£¼ì‹ ì‹œì¥ì€ ê³µíœ´ì¼ì— íœ´ì¥ (ì˜ˆ: 2026-01-01 New Year's Day)
- yfinance APIëŠ” ìµœì‹  ë°ì´í„°ë¥¼ ì œê³µí•˜ì§€ ì•Šê±°ë‚˜ Rate Limitì— ê±¸ë¦¼
- ì‚¬ìš©ì ìš”êµ¬: **"ë§ˆì§€ë§‰ ì‹œì¥ ë°ì´í„° ê¸°ì¤€ìœ¼ë¡œ ìƒíƒœë¥¼ ìœ ì§€í•´ì•¼ í•¨"**

#### êµ¬í˜„ ë‚´ìš©

##### A. Stale Data ê°ì§€ ë¡œì§
**íŒŒì¼**: `backend/analysis.py` (Lines 1278-1292)

```python
# Check for missing OR stale data (íœ´ì¥ì¼ ëŒ€ì‘)
data_is_stale = False
if df30 is not None and not df30.empty:
    try:
        latest_candle_time = df30.index[-1]
        if latest_candle_time.tzinfo is None:
            latest_candle_time = latest_candle_time.replace(tzinfo=timezone.utc)
        time_since_last_candle = datetime.now(timezone.utc) - latest_candle_time
        # If last candle is older than 12 hours, consider it stale
        if time_since_last_candle.total_seconds() > 43200:  # 12 hours
            data_is_stale = True
    except:
        pass
```

**ë¡œì§**:
1. ë§ˆì§€ë§‰ ìº”ë“¤ì˜ timestampë¥¼ í™•ì¸
2. í˜„ì¬ ì‹œê°ê³¼ ë¹„êµí•˜ì—¬ 12ì‹œê°„ ì´ìƒ ê²½ê³¼í–ˆìœ¼ë©´ "Stale"ë¡œ íŒë‹¨
3. Stale ë°ì´í„°ëŠ” ì‹ ë¢°í•˜ì§€ ì•Šê³  DBì˜ ì˜ì†í™”ëœ state ì‚¬ìš©

##### B. State Persistence (ì˜ì†ì„±)
**íŒŒì¼**: `backend/analysis.py` (Lines 1293-1305)

```python
if df30 is None or df30.empty or df5 is None or df5.empty or data_is_stale:
    # Preserve state even if data fetch fails OR is stale
    if state.get("final_met"):
        result["final"] = True
        result["step1"] = True if state.get("step1_done_time") else False
        result["step2"] = True if state.get("step2_done_time") else False
        result["step3"] = True if state.get("step3_done_time") else False
        result["signal_time"] = state.get("signal_time")
        result["step2_color"] = state.get("step2_color")  # ê²½ê³  ìƒ‰ìƒ ë³µì›
        result["step3_color"] = state.get("step3_color")  # ê²½ê³  ìƒ‰ìƒ ë³µì›
        # ... details ë³µì›
    return result
```

**íš¨ê³¼**:
- íœ´ì¥ì¼ì´ë‚˜ API ì¥ì•  ì‹œì—ë„ ë§ˆì§€ë§‰ ìƒíƒœê°€ ëŒ€ì‹œë³´ë“œì— ìœ ì§€ë¨
- ê²½ê³  ìƒ‰ìƒ(Yellow/Orange/Red)ë„ í•¨ê»˜ ë³´ì¡´
- ì‚¬ìš©ìëŠ” ì‹œì¥ì´ ë‹¤ì‹œ ì—´ë¦´ ë•Œê¹Œì§€ ë§ˆì§€ë§‰ ì‹ í˜¸ë¥¼ ì°¸ê³  ê°€ëŠ¥

##### C. Warning Color Persistence
**íŒŒì¼**: `backend/analysis.py` (Lines 1464-1508)

```python
# Warning 1: 5m Dead Cross â†’ Yellow
if not filter3_met:
    result["step3_color"] = "yellow"
    state["step3_color"] = "yellow"  # DBì— ì €ì¥
    # ... SMS/History ì €ì¥
else:
    state["step3_color"] = None  # ì •ìƒ ë³µê·€ ì‹œ ì´ˆê¸°í™”

# Warning 2: Box Fail â†’ Orange
if state.get("step2_done_time") and not filter2_met:
    result["step2_color"] = "orange"
    state["step2_color"] = "orange"  # DBì— ì €ì¥
else:
    state["step2_color"] = None
```

**ê°œì„ ì **:
- ê²½ê³  ìƒ‰ìƒì„ `global_config.triple_filter_states`ì— ì €ì¥
- ë°ì´í„° ê°­ì´ ìˆì–´ë„ ê²½ê³ ê°€ ì‚¬ë¼ì§€ì§€ ì•ŠìŒ

---

### 3. DB ìºì‹± ì‹œìŠ¤í…œ ì¶”ê°€ ğŸ’¾

#### ëª©ì 
`í•´ì™¸ì£¼ì‹_ë°ì´í„°ìˆ˜ì§‘_ì§€ì¹¨.md`ì— ë”°ë¼ **í•œêµ­íˆ¬ìì¦ê¶Œ (KIS) API ë°ì´í„°ì™€ yfinance ìº”ë“¤ ë°ì´í„°ë¥¼ DBì— ì €ì¥**í•˜ì—¬ ì˜ì†ì„± í™•ë³´

#### ì‹ ê·œ í…Œì´ë¸” ì¶”ê°€
**íŒŒì¼**: `backend/db.py` (Lines 143-173)

##### 1. `price_cache` í…Œì´ë¸”
```sql
CREATE TABLE IF NOT EXISTS price_cache (
    ticker VARCHAR(10) PRIMARY KEY,
    price DECIMAL(10,4),
    diff DECIMAL(10,4),
    rate DECIMAL(6,3),
    exchange VARCHAR(10),
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
)
```
**ìš©ë„**: KIS APIë¡œë¶€í„° ë°›ì€ ì‹¤ì‹œê°„ ê°€ê²©ì„ ì €ì¥ (SOXL, SOXS, UPRO ë“±)

##### 2. `candle_data` í…Œì´ë¸”
```sql
CREATE TABLE IF NOT EXISTS candle_data (
    ticker VARCHAR(10),
    timeframe VARCHAR(5),  -- '5m' or '30m'
    candle_time DATETIME,
    open DECIMAL(10,4),
    high DECIMAL(10,4),
    low DECIMAL(10,4),
    close DECIMAL(10,4),
    volume BIGINT,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (ticker, timeframe, candle_time)
)
```
**ìš©ë„**: yfinanceë¡œë¶€í„° ë°›ì€ 5ë¶„/30ë¶„ë´‰ ë°ì´í„°ë¥¼ ìµœëŒ€ 100ê°œê¹Œì§€ ì €ì¥

#### Helper í•¨ìˆ˜ ì¶”ê°€
**íŒŒì¼**: `backend/db.py` (Lines 770-889)

```python
def save_price_cache(ticker, price_data): ...
def get_price_cache(ticker): ...
def save_candle_data(ticker, timeframe, candles_df): ...
def get_candle_data(ticker, timeframe, limit=100): ...
```

**í˜„ì¬ ìƒíƒœ**: 
- âœ… í…Œì´ë¸” ìƒì„± ì™„ë£Œ
- âœ… Helper í•¨ìˆ˜ êµ¬í˜„ ì™„ë£Œ
- â³ `fetch_data` í•¨ìˆ˜ì— í†µí•© í•„ìš” (í–¥í›„ ì‘ì—…)

---

### 4. ê²½ê³  ë¡œì§ ê°•í™” âš ï¸

#### 30ë¶„ë´‰ ë°ë“œí¬ë¡œìŠ¤ ì¦‰ì‹œ ì´ˆê¸°í™”
**íŒŒì¼**: `backend/analysis.py` (Lines 1362-1397)

**ìš”êµ¬ì‚¬í•­**: 
> "30ë¶„ë´‰ ê¸°ì¤€ì´ ë°ë“œí¬ë¡œìŠ¤ ë°œìƒí•˜ë©´ ë¶‰ì€ìƒ‰ìœ¼ë¡œ ë³€ê²½ë˜ê³  ë¬¸ì ë° íˆìŠ¤í† ë¦¬ ê¸°ë¡ ë‚¨ê¸°ê³  ì²˜ìŒìœ¼ë¡œ ì¡°ê±´ ëŒ€ê¸°ì¤‘ìœ¼ë¡œ ì „í™˜"

**êµ¬í˜„**:
```python
if not filter1_met:  # 30m Dead Cross ë°œìƒ
    if state.get("final_met"):
        result["step1_color"] = "red"
        result["is_sell_signal"] = True
        
        # ì¦‰ì‹œ State ì™„ì „ ì´ˆê¸°í™”
        state = {
            "final_met": False, "signal_time": None,
            "step1_done_time": None, "step2_done_time": None,
            "step3_done_time": None, "step2_done_price": None,
            "reset_start_time": None
        }
        
        # SELL Signal ì €ì¥ (SMS + History)
        save_signal({
            'signal_type': "SELL (MASTER)",
            'position': f"30ë¶„ë´‰ ë°ë“œí¬ë¡œìŠ¤ ë°œìƒ: ì „ëŸ‰ ë§¤ë„ ë° ì´ˆê¸°í™”...",
            # ...
        })
```

**íš¨ê³¼**:
- Red ê²½ê³  â†’ DB ê¸°ë¡ â†’ ì¦‰ì‹œ "ëŒ€ê¸° ì¤‘" ìƒíƒœë¡œ ë¦¬ì…‹
- ë‹¤ìŒ fetch ì‹œì ë¶€í„°ëŠ” íšŒìƒ‰(OFF) ìƒíƒœë¡œ í‘œì‹œ

---

### 5. UI ê°œì„ ì‚¬í•­ ğŸ¨

#### A. ì¡°ê±´ ëŒ€ê¸° ì¤‘ = ì™„ì „íˆ êº¼ì§ (Grey/Dark)
**íŒŒì¼**: `frontend/src/components/MarketInsight.jsx` (Lines 67-71, 98-128)

**ë³€ê²½ ì „**: ì¡°ê±´ ë¯¸ì¶©ì¡± ì‹œì—ë„ í¬ë¯¸í•œ ìœ ì±„ìƒ‰ í‘œì‹œ  
**ë³€ê²½ í›„**: ì™„ì „í•œ íšŒìƒ‰/ë‹¤í¬ ë°°ê²½ìœ¼ë¡œ "OFF" ìƒíƒœ ëª…í™•í™”

```javascript
// Title Color
color: status?.final ? (isBear ? '#60a5fa' : '#ef4444') : '#666'

// Indicator Default (OFF State)
let dotBg = '#0f0f0f'; // Very dark
let dotBorder = 'rgba(255,255,255,0.1)';
let dotColor = '#333';
```

#### B. Warning Color Priority
```javascript
if (backendColor === 'red') {
    dotBg = '#ef4444'; // Red
} else if (backendColor === 'orange') {
    dotBg = '#f97316'; // Orange
} else if (backendColor === 'yellow') {
    dotBg = '#eab308'; // Yellow
} else if (isMet) {
    dotBg = activeColor; // Normal active state
}
```

---

### 6. ìš”ì²­ì‚¬í•­ ê´€ë¦¬ ì‹œìŠ¤í…œ ğŸ“

#### ì‹ ê·œ ê¸°ëŠ¥ ì¶”ê°€
**ëª©ì **: ì‚¬ìš©ì ìš”ì²­ì‚¬í•­ì„ ì²´ê³„ì ìœ¼ë¡œ ì¶”ì  ë° ê´€ë¦¬

#### êµ¬í˜„ ë‚´ìš©

##### Backend API
**íŒŒì¼**: `backend/main.py` (Lines 530-555)

```python
@app.get("/api/requests")
async def get_requests(): ...

@app.post("/api/requests")
async def create_request(item: RequestItem): ...
```

##### Frontend Page
**íŒŒì¼**: `frontend/src/RequestPage.jsx` (ì „ì²´)
- ìš”ì²­ì‚¬í•­ ëª©ë¡ í‘œì‹œ
- AI Interpretation ë° Implementation Details êµ¬ë¶„
- Status í‘œì‹œ (completed/pending)

##### DB í…Œì´ë¸”
**íŒŒì¼**: `backend/db.py`

```sql
CREATE TABLE user_requests (
    id INT AUTO_INCREMENT PRIMARY KEY,
    request_text TEXT,
    ai_interpretation TEXT,
    implementation_details TEXT,
    status VARCHAR(20) DEFAULT 'completed',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
)
```

##### Navigation ì¶”ê°€
**íŒŒì¼**: `frontend/src/App.jsx` (Lines 178-237)
- ì‚¬ì´ë“œë°”ì— "ğŸ“ ìš”ì²­ì‚¬í•­" ë§í¬ ì¶”ê°€
- `/requests` ë¼ìš°íŠ¸ ì„¤ì •

#### í˜„ì¬ ê¸°ë¡ëœ ìš”ì²­ (ID #1)
```json
{
  "request_text": "1. ì¡°ê±´ ëŒ€ê¸°ì¤‘ ìƒíƒœì¼ ê²½ìš° íšŒìƒ‰ í‘œì‹œ\n2. ì‹œê°„ì€ yyyy.MM.dd HH:mm (US/KR) í˜•ì‹ì´ë©° ì°¨íŠ¸ ë°œìƒ ì‹œê°„ ê¸°ì¤€\n3. 5ë¶„ë´‰ ë°ë“œí¬ë¡œìŠ¤(ë…¸ë€ìƒ‰), 30ë¶„ë´‰ ë°ë“œí¬ë¡œìŠ¤(ë¶‰ì€ìƒ‰ ë° ì´ˆê¸°í™”), ë°•ìŠ¤ê¶Œ ì´íƒˆ(ì£¼í™©ìƒ‰) ê²½ê³  ì¶”ê°€\n4. ìš”ì²­ì‚¬í•­ ê¸°ë¡ ë©”ë‰´ ì¶”ê°€ ë° Footer ì—…ë°ì´íŠ¸",
  "status": "completed"
}
```

---

## í•µì‹¬ ê¸°ëŠ¥ êµ¬í˜„ ìƒíƒœ

### âœ… ì™„ë£Œëœ ê¸°ëŠ¥

1. **Master Control Tower (SOXL/SOXS)**
   - íŠ¸ë¦¬í”Œ í•„í„° ë¡œì§ ì™„ì „ êµ¬í˜„
   - State Persistence (DB: `global_config.triple_filter_states`)
   - ê²½ê³  ì‹œìŠ¤í…œ (Yellow/Orange/Red)
   - íœ´ì¥ì¼ Fallback ì§€ì›

2. **ì‹ í˜¸ ê°ì§€ ë° ì•Œë¦¼**
   - BUY (MASTER): 3ê°œ ì¡°ê±´ ëª¨ë‘ ì¶©ì¡± ì‹œ
   - WARNING (5M): 5ë¶„ë´‰ ë°ë“œí¬ë¡œìŠ¤
   - WARNING (BOX): ë°•ìŠ¤ê¶Œ í•˜í–¥ ì´íƒˆ
   - SELL (MASTER): 30ë¶„ë´‰ ë°ë“œí¬ë¡œìŠ¤
   - SMS ì „ì†¡ (30ë¶„ Rate Limit)
   - DB History ì €ì¥

3. **ì‹œê°„ í‘œì‹œ**
   - ì°¨íŠ¸ ê¸°ì¤€ ì‹œê°„ ì‚¬ìš© (`chart_time` from latest candle)
   - Dual Time Display: `yyyy.MM.dd HH:mm (US) / (KR)`
   - Timezone-aware handling (UTC/EST/KST)

4. **ë°ì´í„° ê´€ë¦¬**
   - yfinance ìºì‹± (ë©”ëª¨ë¦¬: 1ë¶„/10ë¶„ Tier)
   - KIS API í†µí•© (ì‹¤ì‹œê°„ ê°€ê²©)
   - DB ìºì‹± ì‹œìŠ¤í…œ (price_cache, candle_data)

5. **UI/UX**
   - ëŒ€ê¸° ì¤‘: íšŒìƒ‰/ë‹¤í¬ (ì™„ì „íˆ OFF)
   - í™œì„±í™”: ìƒ‰ìƒ + Glow ì• ë‹ˆë©”ì´ì…˜
   - ê²½ê³ : ìƒ‰ìƒ ìš°ì„ ìˆœìœ„ ì ìš©
   - ìš”ì²­ì‚¬í•­ í˜ì´ì§€

### â³ ì§„í–‰ ì¤‘ / ê³„íš

1. **KIS API ì™„ì „ í†µí•©**
   - `fetch_data`ì— KIS ìš°ì„  ì‚¬ìš© ë¡œì§ ì¶”ê°€
   - DB ìºì‹œ ìë™ ì €ì¥ ë£¨í‹´
   - yfinance â†’ DB fallback ìë™í™”

2. **ë°±í…ŒìŠ¤íŒ… ì‹œìŠ¤í…œ**
   - ê³¼ê±° ë°ì´í„° ê¸°ë°˜ ì „ëµ ê²€ì¦
   - ìŠ¹ë¥  ë° ìˆ˜ìµë¥  ë¶„ì„

3. **ì‹¤ì „ ìë™ ë§¤ë§¤**
   - KIS APIë¥¼ í†µí•œ ì‹¤ì œ ì£¼ë¬¸ ì—°ë™ (í˜„ì¬ëŠ” ë¶„ì„ë§Œ)

---

## ì•Œë ¤ì§„ ì´ìŠˆ ë° í•´ê²° ë°©ë²•

### 1. yfinance Rate Limit
**ì¦ìƒ**: `YFRateLimitError: Too Many Requests`

**ì›ì¸**: 
- ë„ˆë¬´ ë¹ˆë²ˆí•œ API í˜¸ì¶œ
- ë™ì¼ IPì—ì„œ ê³¼ë„í•œ ìš”ì²­

**í•´ê²°**:
1. **ë‹¨ê¸°**: 10-15ë¶„ ëŒ€ê¸° (ìë™ í•´ì œ)
2. **ì¤‘ê¸°**: í˜„ì¬ êµ¬í˜„ëœ ë©”ëª¨ë¦¬ ìºì‹± í™œìš© (1ë¶„/10ë¶„ Tier)
3. **ì¥ê¸°**: KIS APIë¡œ ì „í™˜ + DB ìºì‹± ì™„ì „ êµ¬í˜„

### 2. ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ `source: not found`
**íŒŒì¼**: `deploy.sh`

**ë¬¸ì œ**: `sh` ì…¸ì—ì„œ `source` ëª…ë ¹ì–´ ë¯¸ì§€ì›

**í•´ê²°**:
```bash
#!/bin/bash  # sh â†’ bashë¡œ ë³€ê²½
source backend/venv/bin/activate
```

### 3. Frontend ë¹Œë“œ ê¶Œí•œ ì˜¤ë¥˜
**ì¦ìƒ**: `EACCES: permission denied, unlink '/home/blue/.../dist/...'`

**í•´ê²°**:
```bash
sudo chown -R blue:blue /home/blue/blue/my_project/money/frontend
```

### 4. Systemd Service Port ì¶©ëŒ
**ì¦ìƒ**: `Address already in use (0.0.0.0:9100)`

**í•´ê²°**:
```bash
lsof -i :9100  # í”„ë¡œì„¸ìŠ¤ í™•ì¸
kill -9 [PID]  # ê°•ì œ ì¢…ë£Œ
sudo systemctl restart cheongan-backend
```

---

## ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

### ë””ë ‰í† ë¦¬ êµ¬ì¡°
```
money/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ analysis.py          # í•µì‹¬ ë¶„ì„ ë¡œì§ (1,663 lines)
â”‚   â”œâ”€â”€ db.py                # DB ì—°ê²° ë° Helper (889 lines)
â”‚   â”œâ”€â”€ kis_api.py           # í•œêµ­íˆ¬ìì¦ê¶Œ API
â”‚   â”œâ”€â”€ main.py              # FastAPI ì•± (559 lines)
â”‚   â””â”€â”€ venv/                # Python ê°€ìƒí™˜ê²½
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ App.jsx          # ë©”ì¸ ë¼ìš°í„° (247 lines)
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ MarketInsight.jsx  # Master Control Tower
â”‚   â”‚   â”‚   â””â”€â”€ FinalSignal.jsx    # Portfolio ìš”ì•½
â”‚   â”‚   â”œâ”€â”€ SignalPage.jsx   # ì‹ í˜¸ íˆìŠ¤í† ë¦¬
â”‚   â”‚   â”œâ”€â”€ RequestPage.jsx  # ìš”ì²­ì‚¬í•­ ê´€ë¦¬ (NEW)
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ dist/                # ë¹Œë“œ ê²°ê³¼ë¬¼ (Nginx ì„œë¹™)
â”œâ”€â”€ deploy.sh                # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸
â”œâ”€â”€ CHANGELOG.md             # ë³€ê²½ ì´ë ¥
â”œâ”€â”€ í•´ì™¸ì£¼ì‹_ë°ì´í„°ìˆ˜ì§‘_ì§€ì¹¨.md
â”œâ”€â”€ ì‹¤ì „_ë§¤ë§¤_ì „ëµ_ì§€ì¹¨.md
â””â”€â”€ ì§„í–‰ì‚¬í•­.md             # ì´ íŒŒì¼
```

### ë°ì´í„° íë¦„
```
[yfinance API] â”€â”€â”€â”€â”€â”€â”
                     â†“
              [fetch_data] â”€â†’ [Memory Cache]
                     â†“
[KIS API] â”€â”€â†’ [Analysis Logic] â”€â†’ [DB: Signals, State]
                     â†“
              [FastAPI Response]
                     â†“
              [React Dashboard]
```

### ì£¼ìš” DB í…Œì´ë¸”
1. **signal_history**: ëª¨ë“  ì‹ í˜¸ ê¸°ë¡
2. **sms_logs**: SMS ì „ì†¡ ì´ë ¥
3. **transactions**: ë§¤ë§¤ ê¸°ë¡
4. **managed_stocks**: ì¶”ì  ì¢…ëª© ì„¤ì •
5. **global_config**: JSON ì„¤ì • (triple_filter_states ë“±)
6. **user_requests**: ì‚¬ìš©ì ìš”ì²­ì‚¬í•­ (NEW)
7. **price_cache**: KIS ê°€ê²© ìºì‹œ (NEW)
8. **candle_data**: ìº”ë“¤ ë°ì´í„° ìºì‹œ (NEW)

---

## ë°°í¬ ë° ìš´ì˜

### ë°°í¬ í”„ë¡œì„¸ìŠ¤
```bash
# ìˆ˜ë™ ë°°í¬
cd /home/blue/blue/my_project/money
bash deploy.sh
```

**deploy.sh ì£¼ìš” ë‹¨ê³„**:
1. Backend ì„œë¹„ìŠ¤ ì¬ì‹œì‘ (`cheongan-backend.service`)
2. Frontend ë¹Œë“œ (`npm run build`)
3. Nginx ìë™ reload (dist ë””ë ‰í† ë¦¬ ë³€ê²½ ê°ì§€)

### ì„œë¹„ìŠ¤ ê´€ë¦¬
```bash
# Backend ìƒíƒœ í™•ì¸
sudo systemctl status cheongan-backend

# ë¡œê·¸ í™•ì¸
journalctl -u cheongan-backend -n 50 --no-pager

# ì¬ì‹œì‘
sudo systemctl restart cheongan-backend
```

### Nginx ì„¤ì •
**íŒŒì¼**: `/etc/nginx/sites-enabled/money`

```nginx
server {
    server_name money.mysmartgate.kr;
    
    location / {
        root /home/blue/blue/my_project/money/frontend/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    location /api {
        proxy_pass http://127.0.0.1:9100;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### Backend Service
**íŒŒì¼**: `/etc/systemd/system/cheongan-backend.service`

```ini
[Service]
User=blue
WorkingDirectory=/home/blue/blue/my_project/money/backend
Environment="PATH=/home/blue/blue/my_project/money/backend/venv/bin"
ExecStart=/home/blue/blue/my_project/money/backend/venv/bin/gunicorn \
    -k uvicorn.workers.UvicornWorker main:app \
    --bind 0.0.0.0:9100 \
    --workers 2
```

---

## ë‹¤ìŒ ë‹¨ê³„

### ìš°ì„ ìˆœìœ„ â­â­â­
1. **KIS API ì™„ì „ í†µí•©**
   - `fetch_data`ì—ì„œ SOXL/SOXS/UPROëŠ” KIS API ìš°ì„  ì‚¬ìš©
   - DB ìºì‹± ìë™í™” (save_candle_data í˜¸ì¶œ)
   - yfinance ì‹¤íŒ¨ ì‹œ DB fallback ìë™ ì „í™˜

2. **State ì•ˆì •ì„± ê²€ì¦**
   - ì‹¤ì œ ì‹œì¥ ê°œì¥ í›„ íœ´ì¥ì¼ fallback í…ŒìŠ¤íŠ¸
   - ê²½ê³  ìƒ‰ìƒ Persistence ë™ì‘ í™•ì¸

### ì¤‘ìš”ë„ â­â­
3. **ì„±ëŠ¥ ìµœì í™”**
   - DB Connection Pool êµ¬í˜„
   - ë¶ˆí•„ìš”í•œ yfinance í˜¸ì¶œ ìµœì†Œí™”
   - Frontend ë¹Œë“œ ìºì‹œ ê°œì„ 

4. **ëª¨ë‹ˆí„°ë§ ê°•í™”**
   - ì—ëŸ¬ ì•Œë¦¼ ì‹œìŠ¤í…œ (Slack/Discord)
   - ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘

### ì¥ê¸° ê³„íš â­
5. **ìë™ ë§¤ë§¤ ì—°ë™**
   - KIS API ì£¼ë¬¸ ê¸°ëŠ¥ í™œì„±í™”
   - ë¦¬ìŠ¤í¬ ê´€ë¦¬ Rule Engine

6. **ë°±í…ŒìŠ¤íŒ… ì‹œìŠ¤í…œ**
   - ê³¼ê±° ë°ì´í„° ê¸°ë°˜ ì „ëµ ê²€ì¦
   - ìµœì  íŒŒë¼ë¯¸í„° íƒìƒ‰

---

## ì°¸ê³  ë¬¸ì„œ

### í”„ë¡œì íŠ¸ ë¬¸ì„œ
- `í•´ì™¸ì£¼ì‹_ë°ì´í„°ìˆ˜ì§‘_ì§€ì¹¨.md`: ë°ì´í„° ì†ŒìŠ¤ ë° ìˆ˜ì§‘ ê·œì¹™
- `ì‹¤ì „_ë§¤ë§¤_ì „ëµ_ì§€ì¹¨.md`: íŠ¸ë ˆì´ë”© ì•Œê³ ë¦¬ì¦˜ ì •ì±…
- `í™˜ê²½ì„¤ì •.md`: ì„œë²„ ë° API ì„¤ì •
- `CHANGELOG.md`: ë²„ì „ë³„ ë³€ê²½ ì´ë ¥

### ì™¸ë¶€ ë¬¸ì„œ
- [yfinance Documentation](https://github.com/ranaroussi/yfinance)
- [í•œêµ­íˆ¬ìì¦ê¶Œ Open API](https://apiportal.koreainvestment.com/)
- [FastAPI Documentation](https://fastapi.tiangolo.com/)

---

## ë²„ì „ íˆìŠ¤í† ë¦¬

### Ver 2.4.3 (2026-01-02 02:33)
- âœ… `us_et` ë³€ìˆ˜ ì˜¤ë¥˜ ìˆ˜ì • (ì¹˜ëª…ì )
- âœ… íœ´ì¥ì¼ Fallback ì‹œìŠ¤í…œ êµ¬ì¶•
- âœ… DB ìºì‹± í…Œì´ë¸” ì¶”ê°€ (price_cache, candle_data)
- âœ… ê²½ê³  ìƒ‰ìƒ Persistence êµ¬í˜„
- âœ… ìš”ì²­ì‚¬í•­ ê´€ë¦¬ í˜ì´ì§€ ì¶”ê°€

### Ver 2.4.2 (2026-01-02 02:22)
- Dashboard UI ê°œì„  (ì¡°ê±´ ëŒ€ê¸° = íšŒìƒ‰)
- Dual Time Display (US/KR)
- ê²½ê³  ë¡œì§ ì¶”ê°€ (Yellow/Orange/Red)

### Ver 2.4.0 ì´ì „
- Master Signal ì‹œìŠ¤í…œ êµ¬í˜„
- KIS API ì—°ë™
- ê¸°ë³¸ Dashboard êµ¬ì¶•

---

## ê°œë°œì ë…¸íŠ¸

### ì¤‘ìš” í¬ì¸íŠ¸
1. **ì ˆëŒ€ë¡œ `datetime.now()`ë¥¼ ì‹ í˜¸ ì‹œê°„ìœ¼ë¡œ ì‚¬ìš©í•˜ì§€ ë§ ê²ƒ**
   - í•­ìƒ `chart_time` (latest candle) ì‚¬ìš©
   - Reason: ì„œë²„ ì‹œê°„ê³¼ ì‹œì¥ ì‹œê°„ì˜ ë¶ˆì¼ì¹˜ ë°©ì§€

2. **StateëŠ” í•­ìƒ DBì— ì˜ì†í™”**
   - ë©”ëª¨ë¦¬ ìºì‹œëŠ” íœ˜ë°œì„±
   - `global_config.triple_filter_states` í•„ìˆ˜

3. **ê²½ê³  ìƒ‰ìƒì€ Stateì— ì €ì¥**
   - `step2_color`, `step3_color`
   - ë°ì´í„° ê°­ì—ë„ ìœ ì§€ë˜ì–´ì•¼ í•¨

4. **SQL ì˜ˆì•½ì–´ ì£¼ì˜**
   - `interval` â†’ `timeframe`ìœ¼ë¡œ ë³€ê²½í•¨

### ë””ë²„ê¹… íŒ
```bash
# Backend ë¡œê·¸ ì‹¤ì‹œê°„ í™•ì¸
journalctl -u cheongan-backend -f

# State í™•ì¸
mysql -h 114.108.180.228 -u blueeye -p -D mywork_01 \
  -e "SELECT * FROM global_config WHERE key_name='triple_filter_states';"

# API í…ŒìŠ¤íŠ¸
curl http://localhost:9100/api/report | python3 -m json.tool
```

---

**ë¬¸ì„œ ë** | ìµœì¢… ìˆ˜ì •: 2026-01-02 03:10 KST

---

## ê¸´ê¸‰ ìˆ˜ì • (2026-01-02 13:34)

### ë¬¸ì œ: DB ì—°ê²° ê³ ê°ˆ ì˜¤ë¥˜
```
(2003, "Can't connect to MySQL server on '114.108.180.228' 
([Errno 24] Too many open files)")
```

### ì›ì¸
- `get_connection()`ì´ ë§¤ë²ˆ ìƒˆë¡œìš´ DB ì—°ê²° ìƒì„±
- ì¼ë¶€ í•¨ìˆ˜ì—ì„œ ì—°ê²°ì´ ì œëŒ€ë¡œ ë‹«íˆì§€ ì•ŠìŒ (connection leak)
- ì‹œê°„ì´ ì§€ë‚˜ë©´ì„œ íŒŒì¼ ë””ìŠ¤í¬ë¦½í„° ê³ ê°ˆ

### í•´ê²°ì±…: Connection Pool êµ¬í˜„
**íŒŒì¼**: `backend/db.py` (Lines 1-51)

#### ë³€ê²½ì‚¬í•­
1. **DBUtils íŒ¨í‚¤ì§€ ì¶”ê°€**
   ```bash
   pip install DBUtils==3.1.2
   ```

2. **Connection Pool êµ¬í˜„**
   ```python
   from dbutils.pooled_db import PooledDB
   
   _connection_pool = PooledDB(
       creator=pymysql,
       maxconnections=10,  # ìµœëŒ€ ì—°ê²° ìˆ˜
       mincached=2,        # ìµœì†Œ ìœ íœ´ ì—°ê²°
       maxcached=5,        # ìµœëŒ€ ìœ íœ´ ì—°ê²°
       ping=1,             # ì—°ê²° ìƒíƒœ ìë™ í™•ì¸
       **DB_CONFIG
   )
   ```

3. **get_connection() ê°œì„ **
   - Poolì—ì„œ ì—°ê²° ì¬ì‚¬ìš©
   - ì—°ê²° ìƒíƒœ ìë™ í™•ì¸ (ping=1)
   - ì˜¤ë¥˜ ì‹œ fallback ë©”ì»¤ë‹ˆì¦˜

#### íš¨ê³¼
- âœ… ì—°ê²° ì¬ì‚¬ìš©ìœ¼ë¡œ ë¦¬ì†ŒìŠ¤ íš¨ìœ¨ì„± í–¥ìƒ
- âœ… Connection leak ë°©ì§€
- âœ… ìë™ ì—°ê²° ë³µêµ¬ (ping)
- âœ… ìµœëŒ€ ì—°ê²° ìˆ˜ ì œí•œìœ¼ë¡œ ì•ˆì •ì„± í™•ë³´

#### ê²€ì¦
```bash
# API í…ŒìŠ¤íŠ¸
curl http://localhost:9100/api/report
# Response: OK (9 stocks loaded)

# ë°±ì—”ë“œ ìƒíƒœ
systemctl status cheongan-backend
# Status: active (running)
```

**ë¬¸ì„œ ì—…ë°ì´íŠ¸**: 2026-01-02 13:34 KST
